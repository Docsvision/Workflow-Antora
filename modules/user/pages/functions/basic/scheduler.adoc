= Расписание

.Пиктограмма функции
image::buttons/scheduler.png[Таймер]

[#description]
== Общее описание функции

Функция _Расписание_ выполняет роль таймера, активизируя бизнес-процесс в определенный момент и передавая управление на следующую за ней функцию.

Когда функция расписания включена в цикл, можно добиться активизации бизнес-процесса по определенному графику -- в определенные моменты времени. Такой подход позволяет избежать необходимости повторно создавать экземпляры одного бизнес-процесса.

[#scenarios]
== Сценарии использования

.Функция расписания имеет два режима работы:
* *Однократное срабатывание*: функция срабатывает один раз в определенное время или по истечении указанного периода времени, даже если она является частью цикла.
+
Если функция расписания с однократным срабатыванием получает управление позже указанного для нее времени срабатывания, то она будет выполнена немедленно, если на вкладке _Однократное срабатывание_ свойств функции был установлен флаг `*Учитывать дату*` или на следующий день в заданное время, если этот флаг установлен не был.
+
* *Периодическое срабатывание*: функция срабатывает в соответствии с графиком, рассчитанным по определенному набору параметров.
+
Чтобы функции расписания периодического типа срабатывала повторно, её необходимо включить в цикл.

[#parameters]
== Настройка параметров

.Окно "Расписание". Вкладка "Параметры"
image::scheduler-parameters.png[Окно "Расписание". Вкладка "Параметры"]

На вкладке _Параметры_ окна свойств функции следует указать режим работы функции (*Однократное срабатывание* или *Периодическое срабатывание*), а на вкладках _Однократное срабатывание_ и _Периодическое срабатывание_ -- параметры срабатывания функции в зависимости от её типа и назначения.

Если необходимые для исполнения бизнес-процесса поля функции не были определены или значения переменных пустые, функция остановится по ошибке.

[#singletime]
== Однократное срабатывание

На вкладке _Однократное срабатывание_ в секции _Тип срабатывания_ с помощью переключателей определяется тип срабатывания функции -- *По абсолютному моменту времени* или *По относительному значению времени*. В зависимости от выбранного переключателя следующая секция вкладки отображается в одном из двух возможных вариантов.

По абсолютному моменту времени::
В этом случае следующая секция носит название _Момент срабатывания_ и позволяет установить момент срабатывания функции расписания с помощью переменной типа _дата/время_ или непосредственным заданием значения (с помощью календаря или ввода с клавиатуры). Флаг `*Учитывать дату*` позволяет кроме указанного времени учитывать дату срабатывания, без флага будет учитываться только время.

.Окно "Расписание". Вкладка "Однократное срабатывание (по абсолютному моменту времени)
image::scheduler-triggering-absolute.png[Окно "Расписание". Вкладка "Однократное срабатывание (по абсолютному моменту времени)]

По относительному значению времени::
В этом случае следующая секция носит название _Величина задержки_ и позволяет указать период с момента получения управления функцией расписания до передачи ею управления на следующую функцию. +
Период указывается при помощи целочисленной переменной (название которой указывается в поле _Значение_) или задания значения (в поле _Значение_) и его размерности (в поле _Величина_) -- в секундах, минутах, часах, днях или неделях.

.Окно "Расписание". Вкладка "Однократное срабатывание" (по относительному значению времени)
image::scheduler-triggering-relative.png[Окно "Расписание". Вкладка "Однократное срабатывание" (по относительному значению времени)]

[#periodic]
== Периодическое срабатывание

На вкладке _Периодическое срабатывание_ определяются параметры периодического срабатывания.

.Окно "Расписание". Вкладка "Периодическое срабатывание"
image::scheduler-triggering-periodic.png[Окно "Расписание". Вкладка "Периодическое срабатывание"]

Начальная дата::
Дата и время первого срабатывания функции, причем действуют следующие правила:
+
* Если в поле _Тип повторений_ явно не указывается момент срабатывания функции (например, *_В МАСКА Дни недели через ИНТЕРВАЛ Недель_*), то функция активизируется в момент времени, указанный в данном поле.
* Если поле не заполнено, функция срабатывает в первый раз, когда приходит её очередь и ей передается управление, а затем -- с указанной периодичностью -- в то время суток, когда произошло её первое срабатывание.
* Если управление передано функции расписания позднее _Начальной даты_, расчет следующей её активизации производится, исходя из текущей даты, а не из указанной в этом поле.
* Начальная дата может вводиться как с помощью переменной типа _Дата/Время_, так и указанием конкретного значения.

Тип периодичности::
Правило завершения действия функции расписания -- при достижении некоторой даты (указанной в поле _Конечная дата_) или после определенного количества срабатываний (указанном в поле _Число повторений_), функция выполняется в бесконечном цикле, если тип периодичности не указан.

Конечная дата::
Для типа периодичности _Конечная дата_. Если в момент передачи управления функции расписания значение текущей даты и времени превышает конечное значение даты, функция завершает работу. +
Значение конечной даты можно указать путем ввода с клавиатуры или при помощи переменной типа _Дата/Время_.

Количество повторений::
Для типа периодичности _Количество повторений_ указывается количество срабатываний функции. Можно указать значение вручную или использовать целочисленную переменную.

Тип повторений::
Один из следующих типов повторений:
+
* *_Один раз_* -- однократное повторение.
* *_Каждые ИНТЕРВАЛ мин (час)_* -- повторение каждые <числовое значение> минут/часов/недель/месяцев. Момент следующего срабатывания функции рассчитывается прибавлением к предыдущему моменту значения _Интервала_, которое указывается в следующем поле.
* *_Каждые ИНТЕРВАЛ мин (час) после_* -- повторение каждые <числовое значение> минут/часов/недель/месяцев. Момент следующего срабатывания функции рассчитывается прибавлением значения _Интервала_ (размерность которого указывается в следующем поле) к моменту начала расчета.
* *_В МАСКА часы через ИНТЕРВАЛ дней_* -- повторение в <указание момента времени> часов через <числовое значение> дней (например, в 15:00 через каждые два дня).
* *_В МАСКА дни недели через ИНТЕРВАЛ недель_* -- повторение каждые <указание дней недели> через <числовое значение> недель (например, каждую среду через каждые три недели в момент времени, указанный в поле _Начальная дата_).
* *_В МАСКА дни месяца через ИНТЕРВАЛ месяцев_* -- повторение каждые <числовое значение> дни месяца через <числовое значение> месяцев (например, каждое 13 и 25 числа месяца через каждые четыре месяца в момент времени, указанный в поле _Начальная дата_).
* *_В МАСКА дни недели через ИНТЕРВАЛ месяцев_* -- повторение каждые <указание дней недели> через <числовое значение> месяцев (например, каждую среду через каждые два месяца в момент времени, указанный в поле _Начальная дата_).
* *_МАСКА месяцы по ИНТЕРВАЛ (по маске) дням_* -- повторение каждый <указание месяца> по <числовое значение> дням (например, каждый апрель восьмого числа в момент времени, указанный в поле _Начальная дата_).
* _МАСКА месяцы по ИНТЕРВАЛ (по маске) дням недели_ -- повторение <указание месяца> по <указание дней недели> (например, каждый апрель и июнь по средам и четвергам в момент времени, указанный в поле _Начальная дата_).

Маска повторений::
Для типа периодичности _Количество повторений_ указываются значения для различных типов повторений. Маска повторений может представлять собой числовое значение (значения), название дня (дней) недели, название месяца (месяцев).

Интервал повторений::
Для типа периодичности _Количество повторений_ определяется число, которое в поле _Тип повторений_ обозначено как _ИНТЕРВАЛ_. Может быть задан интервал повторений переменной бизнес-процесса типа целое, которая работает либо как абсолютная величина (например, *_Через ИНТЕРВАЛ недель_*), либо также как _Маска_ (например, если _ИНТЕРВАЛ_ задает маску дней).

Рассчитанная дата::
В поле может быть указана переменная бизнес-процесса, которой будет присвоено значение даты следующего срабатывания, рассчитанное по параметрам функции, определенным выше на этой же вкладке.

Связь выхода из функции::
Функция, которой будет передано управление бизнес-процессом после достижения конечной даты, означающей выход из цикла.

[NOTE]
====
Переменная для выбора в поле _Связь выхода из функции_ должна быть объявлена в свойствах бизнес-процесса и иметь тип _Дата/Время_.
====

[NOTE]
====
Маска повторений может определяться переменной бизнес-процесса типа целое. Переменная должна представлять собой бинарную маску (бинарная маска -- это 2 в степени, равной требующемуся числу минус один), соответствующую часам, дням недели (с понедельника), числам месяца. Минимальное значение -- `2^0=1`, максимальное значение -- `2^30` для 31 числа. Например, маска второго и двенадцатого чисел месяца определяется следующим образом: `2^(2–1)+2^(12-1)=2050`.
====
