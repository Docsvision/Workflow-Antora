= Сервис Workflow

.Этапы обработки БП сервисом Workflow:
. _Детектор активных процессов_ -- часть службы "Workflow Server" -- осуществляет периодический поиск необработанных бизнес-процессов в системе {dv}, и формирует _список активных процессов_.
+
.В список включаются в порядке обнаружения)
* БП, которые находятся на обработке -- выполняются в данный момент времени.
* БП, которые находятся в очереди на обработку.
* Новые активные процессы, появившиеся в системе со времени проведения предыдущего поиска.
+
. Из _списка активных процессов_ формируется _очередь процессов_, в которую попадают активные, готовые к обработке БП. Из списка выбираются процессы, которых нет в _очереди процессов_ и в _группе обрабатываемых процессов_.
+
Место БП в _очереди процессов_ определяется _числом очков_ у данного БП, которое вычисляется по формуле: `Число очков = число секунд с момента последней обработки процесса + бонус/малус за приоритет + бонус для никогда не обрабатывавшихся процессов`.
+
_Число очков_ рассчитываются таким образом, чтобы любой процесс (даже с самым низким приоритетом) попал на обработку.
+
. Из _очереди процессов_ для обработки выбираются БП с наибольшим _числом очков_. Данные БП попадают в _группу обрабатываемых процессов_.
+
.. На обработку каждого БП выделяется определенное время -- _квант времени_, длительность которого вычисляется по формуле: `квант времени = бонус/малус за приоритет процесса * время обработки процесса (из конфигурации службы)`.
+
Если за отведенный _квант времени_ не были выполнены все _функции_ БП, он будет возвращен в _очередь процессов_ после завершения текущей обрабатываемой _функции_.
+
.. На выполнение каждой _функции_ БП выделяется одинаковое время -- _время ожидания выполнения функции_.
+
Если функция БП не была завершена за _время ожидания выполнения функции_, БП будет объявлен превысившим таймаут, _функция_ продолжит выполняться до естественного или принудительного завершения.
+
Если в _группе обрабатываемых процессов_ набирается определенное количество превысивших таймаут БП, когда другие БП из _очереди процессов_ не могут попасть на обработку. Рабочий процесс (`ExecLogic`) службы _Workflow Server_ будет перезагружен, при этом дается `1` минута на завершение других, нормально работающих БП. В течение этой минуты новые БП на обработку не передаются.
+
. Выполненные БП удаляются из _группы обрабатываемых процессов_. В группу передается следующий БП (с большим приоритетом) из _очереди процессов_.

.Схема работы службы "Workflow Server"
image::admin:wf-server-operation.png[Схема работы службы "Workflow Server"]
