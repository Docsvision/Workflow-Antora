=  Сервис Workflow

Этапы обработки БП сервисом Workflow:

. [.dfn .term]_Детектор активных процессов_ (часть службы «Workflow Server») осуществляет периодический поиск необработанных бизнес-процессов в системе Docsvision, и формирует [.keyword]*список активных процессов*. В список включаются (в порядке обнаружения):
* БП, которые находятся на обработке (выполняются в данный момент времени);
* БП, которые находятся в очереди на обработку;
* новые активные процессы, появившиеся в системе со времени проведения предыдущего поиска.
. Из [.dfn .term]_списка активных процессов_ формируется [.dfn .term]_очередь процессов_, в которую попадают активные, готовые к обработке БП, которых нет в [.dfn .term]_очереди процессов_ и в [.dfn .term]_группе обрабатываемых процессов_.
+
Место БП в [.dfn .term]_очереди процессов_ определяется [.dfn .term]_числом очков_ у данного БП, которое вычисляется по формуле: `Число очков` = `число секунд с               момента последней обработки процесса` + `бонус/малус за               приоритет` + `бонус для никогда не обрабатывавшихся               процессов`.
+
[.dfn .term]_Число очков_ рассчитываются таким образом, чтобы любой процесс (даже с самым низким приоритетом) попал на обработку.
. Из [.dfn .term]_очереди процессов_ для обработки выбираются БП с наибольшим [.dfn .term]_числом очков_. Данные БП попадают в [.dfn .term]_группу обрабатываемых процессов_.
[loweralpha]
.. На обработку каждого БП выделяется определенное время – [.keyword]*квант времени*, длительность которого вычисляется по формуле: `квант                 времени` = `бонус/малус за приоритет процесса` * `время обработки процесса (из конфигурации службы)`.
+
Если за отведенный [.dfn .term]_квант времени_ не были выполнены все [.dfn .term]_функции_ БП, он будет возвращен в [.dfn .term]_очередь процессов_ (после завершения текущей обрабатываемой [.dfn .term]_функции_).
.. На выполнение каждой [.dfn .term]_функции_ БП выделяется одинаковое время - [.dfn .term]_время ожидания выполнения функции_.
+
Если функция БП не была завершена за [.dfn .term]_время ожидания выполнения функции_, БП будет объявлен превысившим таймаут - [.dfn .term]_функция_ продолжит выполняться до естественного или принудительного завершения.
+
Если в [.dfn .term]_группе обрабатываемых процессов_ набирается определенное количество превысивших таймаут БП (когда другие БП из [.dfn .term]_очереди процессов_ не могут попасть на обработку), рабочий процесс (ExecLogic) службы «Workflow Server» будет перезагружен; при этом дается 1 минута на завершение других, нормально работающих БП. В течение этой минуты новые БП на обработку не передаются.
. Выполненные БП удаляются из [.dfn .term]_группы обрабатываемых процессов_. В группу передается следующий БП (с большим приоритетом) из [.dfn .term]_очереди процессов_.

image::Workflow_detector.png[[.fig--title-label]##Рис. 1. ##Схема работы службы «Workflow Server»]

*На уровень выше:* xref:Structureof_program.adoc[Структура Модуля]
