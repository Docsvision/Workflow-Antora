= Кластеризация СУБП

[#top]
С целью распределения нагрузки, обработка бизнес-процессов может быть распределена между экземплярами СУБП, запущенными на нескольких компьютерах.

Для каждого экземпляра СУБП назначается доля обрабатываемых процессов, определяющая процент его загрузки в кластере. Например, если для одного сервиса указана доля `3`, а второго -- `4`, то количество обрабатываемых каждым сервисом процессов будет соотноситься как `3:4`. То есть приблизительно `43%` процессов будет обрабатывать первый сервис, `57%` -- второй.

В случае если один из экземпляров службы не запущен, обработку "его" доли БП осуществляют другие активные экземпляры службы.

Отдельный сервис управления бизнес-процессами выбирает БП для обработки из очереди согласно алгоритму выбора. Выбранный БП будет обрабатываться только сервисом, которым он был выбран, пока сервис остается работоспособен.

[#install]
== Установка и настройка кластера СУБП

Общее описание кластера СУБП приведено <<top,выше>>.

Кластеризация модуля (создание кластера) рекомендуется в случаях, когда число одновременно работающих БП в системе {dv} превышает 5000 экземпляров, исходя из примерного расчета: 1 экземпляр модуля на каждые 5000 активных БП.

.Обязательные условия для работы кластера СУБП:
* Для управления кластером на компьютере с сервером {dv} должна быть установлена серверная часть модуля _{wf}_.
* На всех узлах кластера должна быть установлена одинаковая версия модуля _{wf}_. Обновления и исправления модуля должны устанавливаться на все узлы кластера.
* На всех узлах кластера должен быть установлен одинаковый набор _Шлюзов_.
* Если в настройках модуля _{wf}_ в _Консоли настройки {dv}_ указан _Сертификат_ для подписания и шифрования в БП, он должен быть установлен на всех узлах кластера. Личный ключ сертификата должен быть установлен в локальное хранилище на каждом узле. Сертификат и его ключи должны быть доступны для каждой учетной записи СУБП кластера.
* Дополнительные узлы предъявляют собственные xref:ROOT:requirements-separate.adoc[требования к системе].

.Чтобы настроить кластер {wf}:
. Установите серверную часть модуля _{wf}_ на второй узел кластера следуя xref:install.adoc#server[инструкции по установке].
. Включите второй узел в кластер:
.. Откройте _{cns}_ на компьютере с сервером {dv}.
.. Перейти в раздел настроек menu:Модули расширения[{wf}].
+
.Базовые настройки модуля {wf}
image::wf-console-base.png[Базовые настройки модуля {wf}]
+
.. Введите в поле _Имя компьютера_ сетевое имя второго узла кластера.
.. В поле _Доля процесса_ ввести целое число больше `0`, определяющее относительную нагрузку на данный узел кластера.
+
Чтобы поровну распределить нагрузку между двумя узлами кластера, установите одинаковое значение (например, `1`) в доле процесса у обоих узлов. Чтобы снять нагрузку с определенного узла кластера, установите значение `0` в его в доле процесса.
.. Нажать на кнопку *Добавить*. В список _Сервисы бизнес-процессов_ будет добавлена новая запись с именем компьютера, на указанный узел кластера будут переданы требуемые для работы настройки (данные для подключения к серверу {dv} и др.).
+
.Настройки кластеризации модуля {wf}
image::wf-console-base-cluster.png[Настройки кластеризации модуля {wf}]
+
Позже, чтобы увеличить или уменьшить нагрузку сервиса, выделите его в списке сервисов, измените соответствующим образом значение поля _Доля в процессе_ и нажмите кнопку *Установить*.

Чтобы проверить корректность настроек, на втором узле кластера зайдите в реестр Windows, и проверьте в ветке `{hklm-dv}\Workflow` значения ключей `BaseName` и `SiteUrl`. Здесь должны быть указаны название БД {dv} и адрес сервера {dv}, с которым будет работать второй узел кластера.

[#decluster]
== Удаление сервиса Workflow из кластера

Для корректного удаления сервиса Workflow из кластера выполните следующие действия:

. Остановите сервис.
. На компьютере, на котором установлен сервер {dv}, удалите сервис Workflow из _Консоли настройки {dv}_.
. На компьютере, на котором установлен дополнительный сервис Workflow, удалите его в окне _Установка и удаление программ_.
